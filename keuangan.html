<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rekapitulasi Infaq</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f7f7fb;
      }
      .card {
        border: 0;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      }
      .nav-pills .nav-link.active {
        background: #4f46e5;
      }
      .table thead th {
        background: #f1f1f1;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      tfoot td {
        font-weight: bold;
      }
      #tabel-ringkasan td {
        padding: 8px 12px;
      }
      @media print {
        @page {
          size: A4 landscape;
        }
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="row g-4 align-items-stretch">
        <div class="col-lg-12">
          <div class="card h-100">
            <div class="card-body">
              <ul class="nav nav-pills mb-3">
                <li class="nav-item">
                  <button
                    class="nav-link active"
                    data-bs-toggle="pill"
                    data-bs-target="#home"
                  >
                    Home
                  </button>
                </li>
                <li class="nav-item">
                  <button
                    class="nav-link"
                    data-bs-toggle="pill"
                    data-bs-target="#pemasukan"
                  >
                    Pemasukan
                  </button>
                </li>
                <li class="nav-item">
                  <button
                    class="nav-link"
                    data-bs-toggle="pill"
                    data-bs-target="#pengeluaran"
                  >
                    Pengeluaran
                  </button>
                </li>
                <li class="nav-item">
                  <button
                    class="nav-link"
                    data-bs-toggle="pill"
                    data-bs-target="#ringkasan"
                  >
                    Ringkasan
                  </button>
                </li>
              </ul>

              <div class="tab-content">
                <!-- HOME -->
                <div class="tab-pane fade show active" id="home">
                  <div
                    class="d-flex justify-content-center align-items-center py-5"
                  >
                    <div
                      class="card shadow-lg border-0"
                      style="max-width: 700px; background: #fdfdfd"
                    >
                      <div class="card-body text-center p-5">
                        <h2 class="fw-bold mb-4 text-primary">
                          REKAPITULASI INFAQ
                        </h2>
                        <h4 class="mb-2">SMK BANI ADAM HAWWA (BANAWA)</h4>
                        <h5 class="mb-4" id="tahunAjaran"></h5>
                        <div class="my-4">
                          <img
                            src="logo smk.png"
                            alt="Logo Sekolah"
                            style="max-height: 100px"
                          />
                        </div>
                        <p class="mb-0 fw-semibold">BOARDING SCHOOL</p>
                        <p class="mb-0">
                          KP. BABAKAN MANGGUNG KELURAHAN SUKAJAYA
                        </p>
                        <p class="mb-0">KECAMATAN TAROGONG KIDUL</p>
                        <p class="mb-0">KABUPATEN GARUT</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- PEMASUKAN -->
                <div class="tab-pane fade" id="pemasukan">
                  <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                      Tabel Pemasukan
                    </div>
                    <div class="card-body">
                      <table
                        id="tblIn"
                        class="table table-striped table-bordered"
                        style="width: 100%"
                      >
                        <thead>
                          <tr>
                            <th>Tanggal</th>
                            <th>Sumber Dana</th>
                            <th class="text-end">Jumlah</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- PENGELUARAN -->
                <div class="tab-pane fade" id="pengeluaran">
                  <div class="card mb-3">
                    <div class="card-header bg-danger text-white">
                      Tabel Pengeluaran
                    </div>
                    <div class="card-body">
                      <table
                        id="tblOut"
                        class="table table-striped table-bordered"
                        style="width: 100%"
                      >
                        <thead>
                          <tr>
                            <th>Tanggal</th>
                            <th>Jenis Pengeluaran</th>
                            <th class="text-end">Jumlah</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- RINGKASAN -->
                <div class="tab-pane fade" id="ringkasan">
                  <div class="row g-3 mb-3">
                    <div class="col-md-6">
                      <label for="bulan">Pilih Bulan:</label>
                      <input class="form-control" type="month" id="bulan" />
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                      <button
                        class="btn btn-primary"
                        onclick="previewLaporan()"
                      >
                        Lihat Laporan
                      </button>
                    </div>
                  </div>

                  <div id="laporan-preview" style="display: none">
                    <h3 id="judul-laporan" class="text-center mb-4"></h3>

                    <div class="card mb-3">
                      <div class="card-header bg-success text-white">
                        Pemasukan
                      </div>
                      <div class="card-body">
                        <table
                          class="table table-sm table-striped"
                          id="tabel-pemasukan"
                        ></table>
                      </div>
                    </div>

                    <div class="card mb-3">
                      <div class="card-header bg-danger text-white">
                        Pengeluaran
                      </div>
                      <div class="card-body">
                        <table
                          class="table table-sm table-striped"
                          id="tabel-pengeluaran"
                        ></table>
                      </div>
                    </div>

                    <div class="card mb-3">
                      <div class="card-header bg-primary text-white">
                        Ringkasan
                      </div>
                      <div class="card-body">
                        <table
                          class="table table-bordered"
                          id="tabel-ringkasan"
                        ></table>
                      </div>
                    </div>

                    <div class="text-center g-3 py-5 mb-3 col-mb-8">
                      <button class="btn btn-success" onclick="exportExcel()">
                        Export Excel
                      </button>
                      <button class="btn btn-danger" onclick="exportPDF()">
                        Export PDF
                      </button>
                      <button
                        class="btn btn-secondary"
                        onclick="printLaporan()"
                      >
                        Print Laporan
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- end tab content -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <p class="text-muted small mt-3 text-center">
      Data disimpan di Google Sheets melalui Google Apps Script WebApp.
    </p>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbxzYCRRz5LvcNTJAfvv_5dRfgu5IEvxprR8MWdF6cgfp4H3OuDNU3wsejgZBhiv9q-_/exec";
      let laporanData = { pemasukan: [], pengeluaran: [], bulan: "" };
      const fmtRp = (n) =>
        new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          maximumFractionDigits: 0,
        }).format(n || 0);

      function formatDateOnly(d) {
        if (!d) return "";
        const t = new Date(d);
        return isNaN(t) ? d : t.toLocaleDateString("id-ID");
      }
      document.addEventListener("DOMContentLoaded", () => {
        const tahun = new Date().getFullYear();
        document.getElementById("tahunAjaran").innerText = `TAHUN ${tahun}-${
          tahun + 1
        }`;
        loadData();
      });

      async function loadData() {
        const [dataIn, dataOut] = await Promise.all([
          fetch(`${API_URL}?sheet=Pemasukan`).then((r) => r.json()),
          fetch(`${API_URL}?sheet=Pengeluaran`).then((r) => r.json()),
        ]);
        $("#tblIn").DataTable({
          destroy: true,
          data: dataIn,
          columns: [
            { data: "Tanggal", render: (d) => formatDateOnly(d) },
            { data: "Sumber Dana" },
            { data: "Jumlah", render: (d) => fmtRp(d), className: "text-end" },
          ],
        });
        $("#tblOut").DataTable({
          destroy: true,
          data: dataOut,
          columns: [
            { data: "Tanggal", render: (d) => formatDateOnly(d) },
            { data: "Jenis Pengeluaran" },
            { data: "Jumlah", render: (d) => fmtRp(d), className: "text-end" },
          ],
        });
      }

      async function previewLaporan() {
        const bulan = document.getElementById("bulan").value;
        if (!bulan) return alert("Pilih bulan dulu!");
        const [pemasukanRes, pengeluaranRes] = await Promise.all([
          fetch(`${API_URL}?sheet=Pemasukan`).then((r) => r.json()),
          fetch(`${API_URL}?sheet=Pengeluaran`).then((r) => r.json()),
        ]);
        const [tahun, bln] = bulan.split("-").map(Number);
        const filterByMonth = (data) =>
          data.filter((r) => {
            if (!r.Tanggal) return false;
            const t = new Date(r.Tanggal);
            return (
              `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(
                2,
                "0"
              )}` === bulan
            );
          });
        const pemasukan = filterByMonth(pemasukanRes),
          pengeluaran = filterByMonth(pengeluaranRes);
        const filterBeforeMonth = (data) =>
          data.filter((r) => {
            if (!r.Tanggal) return false;
            const t = new Date(r.Tanggal);
            return (
              t.getFullYear() < tahun ||
              (t.getFullYear() === tahun && t.getMonth() + 1 < bln)
            );
          });
        const totalMasuk = pemasukan.reduce(
          (s, r) => s + Number(r.Jumlah || 0),
          0
        );
        const totalKeluar = pengeluaran.reduce(
          (s, r) => s + Number(r.Jumlah || 0),
          0
        );
        const saldoSebelum =
          filterBeforeMonth(pemasukanRes).reduce(
            (s, r) => s + Number(r.Jumlah || 0),
            0
          ) -
          filterBeforeMonth(pengeluaranRes).reduce(
            (s, r) => s + Number(r.Jumlah || 0),
            0
          );
        const saldoAkhir = saldoSebelum + totalMasuk - totalKeluar;
        laporanData = {
          bulan,
          pemasukan,
          pengeluaran,
          totalMasuk,
          totalKeluar,
          saldoBulanSebelumnya: saldoSebelum,
          saldoAkhir,
        };
        document.getElementById("judul-laporan").innerText =
          "Laporan Keuangan Bulan " +
          new Date(bulan + "-01").toLocaleDateString("id-ID", {
            month: "long",
            year: "numeric",
          });
        document.getElementById("tabel-pemasukan").innerHTML = renderTable(
          pemasukan,
          ["Tanggal", "Sumber Dana", "Jumlah"]
        );
        document.getElementById("tabel-pengeluaran").innerHTML = renderTable(
          pengeluaran,
          ["Tanggal", "Jenis Pengeluaran", "Jumlah"]
        );
        let saldoClass = "table-success";
        if (saldoAkhir < 0) saldoClass = "table-danger";
        else if (saldoAkhir === 0) saldoClass = "table-warning";
        document.getElementById("tabel-ringkasan").innerHTML = `
          <tr><td>Saldo Bulan Sebelumnya</td><td>${fmtRp(
            saldoSebelum
          )}</td></tr>
          <tr><td>Total Pemasukan Bulan Ini</td><td>${fmtRp(
            totalMasuk
          )}</td></tr>
          <tr><td>Total Pengeluaran Bulan Ini</td><td>${fmtRp(
            totalKeluar
          )}</td></tr>
          <tr class="${saldoClass} fw-bold"><td>Saldo Akhir</td><td>${fmtRp(
          saldoAkhir
        )}</td></tr>`;
        document.getElementById("laporan-preview").style.display = "block";
      }

      function renderTable(data, headers) {
        if (data.length === 0)
          return (
            "<tr><td colspan='" +
            (headers.length + 1) +
            "'>Tidak ada data</td></tr>"
          );
        let html =
          "<tr><th>No</th>" +
          headers.map((h) => "<th>" + h + "</th>").join("") +
          "</tr>";
        data.forEach((r, i) => {
          html +=
            "<tr>" +
            "<td>" +
            (i + 1) +
            "</td>" +
            headers
              .map((h) =>
                h === "Tanggal"
                  ? "<td>" + formatDateOnly(r[h]) + "</td>"
                  : h === "Jumlah"
                  ? "<td>" + fmtRp(r[h]) + "</td>"
                  : "<td>" + (r[h] || "") + "</td>"
              )
              .join("") +
            "</tr>";
        });
        return html;
      }

      function exportExcel() {
        if (!laporanData.bulan) return alert("Preview dulu!");
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.json_to_sheet(laporanData.pemasukan),
          "Pemasukan"
        );
        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.json_to_sheet(laporanData.pengeluaran),
          "Pengeluaran"
        );
        const ringkasan = [
          ["Saldo Bulan Sebelumnya", fmtRp(laporanData.saldoBulanSebelumnya)],
          ["Total Pemasukan Bulan Ini", fmtRp(laporanData.totalMasuk)],
          ["Total Pengeluaran Bulan Ini", fmtRp(laporanData.totalKeluar)],
          ["Saldo Akhir", fmtRp(laporanData.saldoAkhir)],
        ];
        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.aoa_to_sheet(ringkasan),
          "Ringkasan"
        );
        XLSX.writeFile(wb, `Laporan_${laporanData.bulan}.xlsx`);
      }

      // Helper buat tabel 2 kolom
      function addTableMultiColumn(doc, title, head, body, options = {}) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const colGap = 10;
        const colWidth = (pageWidth - margin * 2 - colGap) / 2;

        let col = 0;
        let cursorY = options.startY || 20;

        const topY = options.startY || 20;
        const bottomY = pageHeight - margin - 20; // area bawah aman

        // Estimasi tinggi 1 baris tabel (font 9) = 7 mm
        const rowHeight = 7;
        const availableHeight = bottomY - topY;
        const rowsPerBlock = Math.floor(availableHeight / rowHeight);

        const chunks = [];
        for (let i = 0; i < body.length; i += rowsPerBlock) {
          chunks.push(body.slice(i, i + rowsPerBlock));
        }

        chunks.forEach((chunk, idx) => {
          const startX = margin + col * (colWidth + colGap);

          if (idx === 0) {
            doc.setFontSize(11);
            doc.text(title, startX, cursorY);
            cursorY += 5;
          }

          doc.autoTable({
            startY: cursorY,
            margin: { left: startX },
            tableWidth: colWidth,
            head: [head],
            body: chunk,
            theme: "grid",
            styles: { fontSize: 9 },
            headStyles: { fillColor: [240, 240, 240], textColor: 0 },
          });

          cursorY = doc.lastAutoTable.finalY + 10;

          // kalau melewati batas → pindah kolom
          if (cursorY > bottomY) {
            if (col === 0) {
              col = 1;
              cursorY = topY;
            } else {
              doc.addPage("l");
              col = 0;
              cursorY = topY;
            }
          }
        });

        return cursorY;
      }

      async function exportPDF() {
        if (!laporanData.bulan) return alert("Preview dulu!");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4"); // potrait A4

        const pageWidth = doc.internal.pageSize.getWidth();
        let cursorY = 20;

        // Judul bulan
        const bulanTeks = new Date(
          laporanData.bulan + "-01"
        ).toLocaleDateString("id-ID", { month: "long", year: "numeric" });
        doc.setFontSize(14);
        doc.text(
          `Laporan Keuangan Bulan ${bulanTeks}`,
          pageWidth / 2,
          cursorY,
          { align: "center" }
        );
        cursorY += 10;

        // 1. Pemasukan
        doc.setFontSize(11);
        doc.text("Pemasukan", 15, cursorY);
        cursorY += 5;
        doc.autoTable({
          startY: cursorY,
          head: [["No", "Tanggal", "Sumber Dana", "Jumlah"]],
          body: laporanData.pemasukan.map((r, i) => [
            i + 1,
            new Date(r.Tanggal).toLocaleDateString("id-ID"),
            r["Sumber Dana"],
            fmtRp(r.Jumlah),
          ]),
          theme: "grid",
          styles: { fontSize: 9 },
          headStyles: { fillColor: [230, 230, 230], textColor: 0 },
        });
        cursorY = doc.lastAutoTable.finalY + 10;

        // 2. Pengeluaran
        doc.setFontSize(11);
        doc.text("Pengeluaran", 15, cursorY);
        cursorY += 5;
        doc.autoTable({
          startY: cursorY,
          head: [["No", "Tanggal", "Jenis Pengeluaran", "Jumlah"]],
          body: laporanData.pengeluaran.map((r, i) => [
            i + 1,
            new Date(r.Tanggal).toLocaleDateString("id-ID"),
            r["Jenis Pengeluaran"] || "-",
            fmtRp(r.Jumlah),
          ]),
          theme: "grid",
          styles: { fontSize: 9 },
          headStyles: { fillColor: [230, 230, 230], textColor: 0 },
        });
        cursorY = doc.lastAutoTable.finalY + 10;

        // 3. Ringkasan
        doc.setFontSize(11);
        doc.text("Ringkasan", 15, cursorY);
        cursorY += 5;
        doc.autoTable({
          startY: cursorY,
          head: [["Keterangan", "Jumlah"]],
          body: [
            ["Saldo Bulan Sebelumnya", fmtRp(laporanData.saldoBulanSebelumnya)],
            ["Total Pemasukan Bulan Ini", fmtRp(laporanData.totalMasuk)],
            ["Total Pengeluaran Bulan Ini", fmtRp(laporanData.totalKeluar)],
            ["Saldo Akhir", fmtRp(laporanData.saldoAkhir)],
          ],
          theme: "grid",
          styles: { fontSize: 10 },
          headStyles: { fillColor: [230, 230, 230], textColor: 0 },
        });
        cursorY = doc.lastAutoTable.finalY + 20;

        // 4. Tanda tangan
        const tahunCetak = new Date().getFullYear();
        doc.setFontSize(10);
        doc.text("Mengetahui,", 15, cursorY);
        doc.text(
          `Garut, ......... .......... ${tahunCetak}`,
          pageWidth - 80,
          cursorY
        );
        cursorY += 6;
        doc.text("Kepala Sekolah", 15, cursorY);
        doc.text("Bendahara", pageWidth - 80, cursorY);
        cursorY += 30;
        doc.text("( H. Ganjar )", 15, cursorY);
        doc.text("( Syntia A )", pageWidth - 80, cursorY);

        // Simpan
        doc.save(`Laporan_${laporanData.bulan}.pdf`);
      }

      async function printLaporan() {
        if (!laporanData.bulan) return alert("Preview dulu!");
        await previewLaporan();
        window.print();
      }
    </script>
  </body>
</html>
